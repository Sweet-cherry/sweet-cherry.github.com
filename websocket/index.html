<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>WebSocket | 前端笔记</title>
    <meta name="description" content="">
    
    
    <link rel="preload" href="/assets/css/0.styles.8ff45fce.css" as="style"><link rel="preload" href="/assets/js/app.00939f34.js" as="script"><link rel="preload" href="/assets/js/2.8fadd415.js" as="script"><link rel="preload" href="/assets/js/9.ef45ba9b.js" as="script"><link rel="prefetch" href="/assets/js/10.5a0b04e3.js"><link rel="prefetch" href="/assets/js/3.15ba62e3.js"><link rel="prefetch" href="/assets/js/4.9d04cf3b.js"><link rel="prefetch" href="/assets/js/5.0901556a.js"><link rel="prefetch" href="/assets/js/6.7c5189cf.js"><link rel="prefetch" href="/assets/js/7.a0c0f5c7.js"><link rel="prefetch" href="/assets/js/8.251ed416.js">
    <link rel="stylesheet" href="/assets/css/0.styles.8ff45fce.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">前端笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><a href="/websocket/" class="nav-link router-link-exact-active router-link-active">WebSocket</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="JavaScript" class="dropdown-title"><span class="title">JavaScript</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/javascript/开发问题总结/question.html" class="nav-link">开发问题总结</a></li><li class="dropdown-item"><!----> <a href="/javascript/数组/array.html" class="nav-link">数组</a></li></ul></div></div><div class="nav-item"><a href="/mongodb/" class="nav-link">MongoDB</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><a href="/websocket/" class="nav-link router-link-exact-active router-link-active">WebSocket</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="JavaScript" class="dropdown-title"><span class="title">JavaScript</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/javascript/开发问题总结/question.html" class="nav-link">开发问题总结</a></li><li class="dropdown-item"><!----> <a href="/javascript/数组/array.html" class="nav-link">数组</a></li></ul></div></div><div class="nav-item"><a href="/mongodb/" class="nav-link">MongoDB</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>WebSocket</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/websocket/#即时通讯" class="sidebar-link">即时通讯</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/websocket/#im通信原理" class="sidebar-link">IM通信原理</a></li><li class="sidebar-sub-header"><a href="/websocket/#即时通讯常用的方式" class="sidebar-link">即时通讯常用的方式</a></li></ul></li><li><a href="/websocket/#websocket-2" class="sidebar-link">WebSocket</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/websocket/#websocket工作机制" class="sidebar-link">WebSocket工作机制</a></li><li class="sidebar-sub-header"><a href="/websocket/#websocket协议" class="sidebar-link">WebSocket协议</a></li><li class="sidebar-sub-header"><a href="/websocket/#websocket属性" class="sidebar-link">WebSocket属性</a></li><li class="sidebar-sub-header"><a href="/websocket/#websocket事件" class="sidebar-link">WebSocket事件</a></li><li class="sidebar-sub-header"><a href="/websocket/#websocket-方法" class="sidebar-link">WebSocket 方法</a></li><li class="sidebar-sub-header"><a href="/websocket/#示例" class="sidebar-link">示例</a></li></ul></li><li><a href="/websocket/#socket-io-js" class="sidebar-link">socket.io.js</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/websocket/#导库" class="sidebar-link">导库</a></li><li class="sidebar-sub-header"><a href="/websocket/#服务端api" class="sidebar-link">服务端API</a></li><li class="sidebar-sub-header"><a href="/websocket/#客户端api" class="sidebar-link">客户端API</a></li></ul></li><li><a href="/websocket/#前后端异步通讯示例" class="sidebar-link">前后端异步通讯示例</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/websocket/#服务端" class="sidebar-link">服务端</a></li><li class="sidebar-sub-header"><a href="/websocket/#客户端" class="sidebar-link">客户端</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="websocket"><a href="#websocket" class="header-anchor">#</a> WebSocket</h1> <h2 id="即时通讯"><a href="#即时通讯" class="header-anchor">#</a> 即时通讯</h2> <ul><li>即时通讯（Instant messaging，简称IM）是一个终端服务，允许两人或多人使用网路即时的传递文字讯息、档案、语音与视频交流</li> <li>即时通讯按使用用途分为企业即时通讯和网站即时通讯</li> <li>根据装载的对象又可分为手机即时通讯和PC即时通讯，手机即时通讯代表是短信，网站、视频即时通讯</li></ul> <h3 id="im通信原理"><a href="#im通信原理" class="header-anchor">#</a> IM通信原理</h3> <p>客户端A与客户端B如何产生通信？</p> <ul><li>A和B是无法直接通讯的，需要通过IM服务器，</li> <li>A、B通过socket与IM服务器产生连接</li> <li>A先把信息发送给IM应用服务器，服务器根据A信息中携带的接收者将它再转发给B，同样B到A也是这种模式</li> <li>服务器是不能主动连接客户端的，只能客户端主动连接服务器</li></ul> <h3 id="即时通讯常用的方式"><a href="#即时通讯常用的方式" class="header-anchor">#</a> 即时通讯常用的方式</h3> <ol><li><strong>短轮询:</strong> <ul><li>每隔一小段时间就发送一个请求到服务器，服务器返回最新数据，然后客户端根据获得的数据来更新界面，这样就间接实现了即时通信</li> <li>主要是客户端人员写代码，服务器人员比较简单，适于小型应用</li> <li>缺点是对服务器压力较大，浪费带宽流量（通常情况下服务器端的数据可能并没有更新），非常低效的实时方案。</li></ul></li> <li><strong>长轮询:</strong> <ul><li>客户端发送一个请求到服务器，服务器查看客户端请求的数据(服务器中数据)是否发生了变化（是否有最新数据），如果发生变化则立即响应返回，否则保持这个连接并定期检查最新数据，直到发生了数据更新或连接超时</li> <li>实现方式：在服务器的程序中加入一个死循环，在循环中监测数据的变动。当发现新数据时，立即将其输出给浏览器并断开连接，浏览器在收到数据后，再次发起请求以进入下一个周期</li> <li>服务器长时间连接会消耗资源，返回数据顺序无保证，如果服务端的数据变更非常频繁的话，这种机制和定时轮询比较起来没有本质上的性能的提高。</li></ul></li> <li><strong>SSE:</strong> <ul><li>（Server-sent Events服务器推送事件）:为了解决浏览器只能够单向传输数据到服务端，HTML5提供了一种新的技术叫做服务器推送事件SSE</li> <li>SSE技术提供的是从服务器单向推送数据给浏览器的功能，加上配合浏览器主动HTTP请求，两者结合起来,实际上就实现了客户端和服务器的双向通信.</li></ul></li> <li><strong>WebSocket</strong><br>
以上方案都是在用 Ajax 方式来模拟实时的效果，在每次客户端和服务器端交互的时候都是一次 HTTP 的请求和应答的过程，而每一次的 HTTP 请求和应答都带有完整的 HTTP 头信息，其中真正有效的数据可能只是很小的一部分，显然这样会浪费很多的带宽等资源。
<ul><li>在HTML5中，为了加强web的功能，提供了websocket技术，它不仅是一种web通信方式，也是一种应用层协议</li> <li>服务端可以主动向客户端推送信息，客户端也可以主动向服务端发送信息，是真正的双向平等对话，属于服务器推送技术的一种。</li></ul></li></ol> <h2 id="websocket-2"><a href="#websocket-2" class="header-anchor">#</a> WebSocket</h2> <h3 id="websocket工作机制"><a href="#websocket工作机制" class="header-anchor">#</a> WebSocket工作机制</h3> <ul><li>WebSocket 是 HTML5 开始提供的一种在单个 TCP 连接上进行全双工通讯的协议</li> <li>WebSocket使通讯非常简单，普通TCP需要三次握手，WebSocket只需要一次握手，浏览器和服务器直接可以创建持久性的连接，并进行双向数据传输。</li> <li>由于WebSockets连接长期存在，与典型的HTTP连接不同，对服务器有重要的影响，任何实际的WebSockets服务器端实现都需要一个异步服务器</li></ul> <h3 id="websocket协议"><a href="#websocket协议" class="header-anchor">#</a> WebSocket协议</h3> <p>协议头: ws, 服务器根据协议头判断是Http还是websocket</p> <div class="language-bash extra-class"><pre class="language-bash"><code>// 请求头
     GET ws://localhost:12345/websocket/test.html HTTP/1.1
     Origin: http://localhost
     Connection: Upgrade
     Host: localhost:12345
     Sec-WebSocket-Key: <span class="token assign-left variable">JspZdPxs9MrWCt3j6h7KdQ</span><span class="token operator">==</span>  
     Upgrade: websocket 
     Sec-WebSocket-Version: <span class="token number">13</span>
     

// 响应头
     HTTP/1.1 <span class="token number">101</span> Web Socket Protocol Handshake
     WebSocket-Location: ws://localhost:12345/websocket/test.php
     Connection: Upgrade
     Upgrade: websocket
     Sec-WebSocket-Accept: zUyzbJdkVJjhhu8KiAUCDmHtY/o<span class="token operator">=</span> 
     WebSocket-Origin: http://localhost
</code></pre></div><h3 id="websocket属性"><a href="#websocket属性" class="header-anchor">#</a> WebSocket属性</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> Socket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token punctuation">[</span>protocol<span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>以上代码创建Socket 对象，第一个参数 url, 指定连接的 URL。第二个参数 protocol 是可选的，指定了可接受的子协议。
以下是 WebSocket 对象的属性。</p> <table><thead><tr><th style="text-align:left;">属性</th> <th style="text-align:left;">描述</th></tr></thead> <tbody><tr><td style="text-align:left;">Socket.readyState</td> <td style="text-align:left;">只读属性 readyState 表示连接状态，可以是以下值 ： 0 - 表示连接尚未建立。 1 - 表示连接已建立，可以进行通信。  2 - 表示连接正在进行关闭。 3 - 表示连接已经关闭或者连接不能打开。</td></tr> <tr><td style="text-align:left;">Socket.bufferedAmount</td> <td style="text-align:left;">只读属性 bufferedAmount 已被 send() 放入正在队列中等待传输，但是还没有发出的 UTF-8 文本字节数。</td></tr></tbody></table> <h3 id="websocket事件"><a href="#websocket事件" class="header-anchor">#</a> WebSocket事件</h3> <table><thead><tr><th style="text-align:left;">事件</th> <th style="text-align:left;">事件处理程序</th> <th style="text-align:left;">描述</th></tr></thead> <tbody><tr><td style="text-align:left;">open</td> <td style="text-align:left;">Socket.onopen</td> <td style="text-align:left;">连接建立时触发</td></tr> <tr><td style="text-align:left;">message</td> <td style="text-align:left;">Socket.onmessage</td> <td style="text-align:left;">客户端接收服务端数据时触发</td></tr> <tr><td style="text-align:left;">error</td> <td style="text-align:left;">Socket.onerror</td> <td style="text-align:left;">通信发生错误时触发</td></tr> <tr><td style="text-align:left;">close</td> <td style="text-align:left;">Socket.onclose</td> <td style="text-align:left;">连接关闭时触发</td></tr></tbody></table> <h3 id="websocket-方法"><a href="#websocket-方法" class="header-anchor">#</a> WebSocket 方法</h3> <table><thead><tr><th style="text-align:left;">方法</th> <th style="text-align:left;">描述</th></tr></thead> <tbody><tr><td style="text-align:left;">Socket.send()</td> <td style="text-align:left;">使用连接发送数据</td></tr> <tr><td style="text-align:left;">Socket.close()</td> <td style="text-align:left;">关闭连接</td></tr></tbody></table> <h3 id="示例"><a href="#示例" class="header-anchor">#</a> 示例</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 客户端</span>
<span class="token keyword">var</span> socket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span><span class="token string">&quot;ws://localhost:9090&quot;</span><span class="token punctuation">)</span>

<span class="token comment">// 建立 web socket 连接成功触发事件</span>
socket<span class="token punctuation">.</span><span class="token function-variable function">onopen</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 使用send发送数据</span>
    socket<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">&quot;发送数据&quot;</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>socket<span class="token punctuation">.</span>bufferedAmount<span class="token punctuation">)</span>
    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'数据发送中'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 接受服务端数据是触发事件</span>
socket<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">evt</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> received_msg <span class="token operator">=</span> evt<span class="token punctuation">.</span>data
    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'数据已经接受..'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 断开 websocket 连接成功触发事件</span>
socket<span class="token punctuation">.</span><span class="token function-variable function">onclose</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'链接已经关闭'</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>socket<span class="token punctuation">.</span>readyState<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="socket-io-js"><a href="#socket-io-js" class="header-anchor">#</a> socket.io.js</h2> <p>Socket.IO是一个库，完全由JavaScript实现、基于Node.js、支持WebSocket协议用于实时通信、跨平台的开源框架，将Websocket和轮询（Polling）机制以及其它的实时通信方式封装成了通用的接口，并且在服务端实现了这些实时通信机制。
网上百度中有人提到：不是所有浏览器都支持websocket,但是socket.io不仅封装了websocket,还用到了其他技术模拟websocket,所以大多浏览器是支持的（但是，IE还是个坑，我目前在vue项目中引的js不能适配IE，不过网上有说可以用vue-socket.io-extended,<a href="https://blog.csdn.net/zfz5720/article/details/89472303" target="_blank" rel="noopener noreferrer">详情<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>）</p> <h3 id="导库"><a href="#导库" class="header-anchor">#</a> 导库</h3> <div class="language- extra-class"><pre class="language-text"><code>npm install socket.io --save
//或者CDN
&lt;script src=&quot;https://cdn.bootcss.com/socket.io/2.2.0/socket.io.js&quot;&gt;&lt;/script&gt;
</code></pre></div><div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>注意：服务器端千万别装最新的2.3.0的，会报错，亲测成功的是express@4.16.1 + socket.io@2.2.0</p></div> <h3 id="服务端api"><a href="#服务端api" class="header-anchor">#</a> 服务端API</h3> <p>socket.io内部实例化并监听http.Server，调用listen或attach函数进行隐式绑定。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> io <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'socket.io'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
io<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span> 
<span class="token comment">//或者</span>
io<span class="token punctuation">.</span><span class="token function">dispath</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span>
</code></pre></div><div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>注意：由于我是在app.js里想拿到io,传到router里去调用，www.js中只能用dispatch，用listen会报错，但是如果不在router里写，直接www.js里调用socket各种操作，则listen执行正常</p></div> <div class="language-js extra-class"><pre class="language-js"><code>监听事件：<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
广播事件；<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">/**
 * 聊天室代码
 */</span>
chatcore<span class="token punctuation">.</span><span class="token function-variable function">init</span> <span class="token operator">=</span> <span class="token parameter">io</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    io<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'connection'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">socket</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'websocket has connected'</span><span class="token punctuation">)</span>
        socket<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> reply<span class="token punctuation">:</span> <span class="token string">'欢迎链接'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//监听客户端发送信息事件</span>
        socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'say'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>sends <span class="token operator">===</span> <span class="token string">'走，一起吃饭吧'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            io<span class="token punctuation">.</span>sockets<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'news'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> reply<span class="token punctuation">:</span> <span class="token string">'果断走起呀！'</span> <span class="token punctuation">,</span> replyName<span class="token punctuation">:</span> <span class="token string">'逗比的系统'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span>
          <span class="token punctuation">}</span>
          <span class="token comment">//响应客户端一个news事件，广播接收到的消息</span>
          <span class="token comment">//socket.emit('news', { reply: data.sends, replyName: data.name });// 给当前客户端发送数据，其他客户端收不到.</span>
          <span class="token comment">//socket.broadcast.emit('news', { reply: data.sends, replyName: data.name });// 发给所有客户端，不包含当前客户端</span>
          io<span class="token punctuation">.</span>sockets<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'news'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> reply<span class="token punctuation">:</span> data<span class="token punctuation">.</span>sends<span class="token punctuation">,</span> replyName<span class="token punctuation">:</span> data<span class="token punctuation">.</span>name <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 发给所有客户端，包含当前客户端</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>详细API见<a href="https://socket.io/docs/client-api/#socket-emit-eventName-%E2%80%A6args-ack" target="_blank" rel="noopener noreferrer">官网<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>  或者 <a href="https://www.w3cschool.cn/socket/socket-k49j2eia.html" target="_blank" rel="noopener noreferrer">w3cschool<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h3 id="客户端api"><a href="#客户端api" class="header-anchor">#</a> 客户端API</h3> <p>创建socket连接对象</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> socket <span class="token operator">=</span> <span class="token function">io</span><span class="token punctuation">(</span><span class="token string">'http://127.0.0.1:3000'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>HTML结构如下</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>chat-box<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span>系统消息：{{sysMsg}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>chat-show<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">v-for</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>(item,index) in dialogList<span class="token punctuation">&quot;</span></span> <span class="token attr-name">:key</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>index<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                    {{`${item.name}说：`}} {{item.msg}}
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>chat-input<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">v-model</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>sendName<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>sendName<span class="token punctuation">&quot;</span></span> <span class="token attr-name">maxlength</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>10<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">v-model</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>sendMsg<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>sendMsg<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>javascript:void(0)<span class="token punctuation">&quot;</span></span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>submitMsg<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>发送消息<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>test-api<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>javascript:void(0)<span class="token punctuation">&quot;</span></span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>goBuy<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>立即订购<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>JS代码如下</p> <div class="language-js extra-class"><pre class="language-js"><code>    watch<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token function">replyMsg</span> <span class="token punctuation">(</span><span class="token parameter">newVal<span class="token punctuation">,</span> oldVal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果服务端返回消息改变，则插入消息队列用于展示</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>dialogList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>msg<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>replyMsg<span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>replyName<span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">created</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>sendName <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultNames<span class="token punctuation">[</span><span class="token function">parseInt</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">beginConnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">replyNews</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    methods<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token function">beginConnect</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 建立socket连接</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>$socket <span class="token operator">=</span> io<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token string">'http://127.0.0.1:3000'</span><span class="token punctuation">)</span>
            <span class="token comment">// 监听 message 会话 socket连接完成后就会传回服务器端指定的消息</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>$socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>sysMsg <span class="token operator">=</span> data<span class="token punctuation">.</span>reply
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function">replyNews</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//监听服务端是否有返回消息</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>$socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'news'</span><span class="token punctuation">,</span> <span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>replyMsg <span class="token operator">=</span> data<span class="token punctuation">.</span>reply
                <span class="token keyword">this</span><span class="token punctuation">.</span>replyName <span class="token operator">=</span> data<span class="token punctuation">.</span>replyName
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function">submitMsg</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//提交</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>$socket<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'say'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>sends<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sendMsg<span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sendName<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//清空消息输入框</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>sendMsg <span class="token operator">=</span> <span class="token string">''</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><p>CSS样式如下</p> <div class="language-css extra-class"><pre class="language-css"><code><span class="token selector">&lt;style lang=&quot;less&quot; scoped&gt;
.chat-box</span><span class="token punctuation">{</span>
    <span class="token property">text-align</span><span class="token punctuation">:</span> left<span class="token punctuation">;</span>
    <span class="token property">width</span><span class="token punctuation">:</span> 800px<span class="token punctuation">;</span>
    <span class="token property">margin</span><span class="token punctuation">:</span> 80px auto<span class="token selector">;
    .chat-input</span><span class="token punctuation">{</span>
        <span class="token property">padding</span><span class="token punctuation">:</span> 16px 0<span class="token selector">;
        input</span><span class="token punctuation">{</span>
            <span class="token property">height</span><span class="token punctuation">:</span> 40px<span class="token punctuation">;</span>
            <span class="token property">line-height</span><span class="token punctuation">:</span> 40px<span class="token punctuation">;</span>
            <span class="token property">border-radius</span><span class="token punctuation">:</span> 5px<span class="token punctuation">;</span>
            <span class="token property">box-shadow</span><span class="token punctuation">:</span> 0 0 10px <span class="token function">rgba</span><span class="token punctuation">(</span>0<span class="token punctuation">,</span> 0<span class="token punctuation">,</span> 0<span class="token punctuation">,</span> .1<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token property">border</span><span class="token punctuation">:</span> 1px solid #e3e3e3<span class="token punctuation">;</span>
            <span class="token property">padding-left</span><span class="token punctuation">:</span> 10px<span class="token selector">;
            &amp;.sendMsg</span><span class="token punctuation">{</span>
                <span class="token property">width</span><span class="token punctuation">:</span> 300px<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token selector">&amp;.sendName</span><span class="token punctuation">{</span>
                <span class="token property">width</span><span class="token punctuation">:</span> 100px<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token selector">a</span><span class="token punctuation">{</span>
            <span class="token property">width</span><span class="token punctuation">:</span> 100px<span class="token punctuation">;</span>
            <span class="token property">line-height</span><span class="token punctuation">:</span> 40px<span class="token punctuation">;</span>
            <span class="token property">text-align</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>
            <span class="token property">text-decoration</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span>
            <span class="token property">background</span><span class="token punctuation">:</span> #0054a6<span class="token punctuation">;</span>
            <span class="token property">display</span><span class="token punctuation">:</span> inline-block<span class="token punctuation">;</span>
            <span class="token property">color</span><span class="token punctuation">:</span> #fff<span class="token punctuation">;</span>
            <span class="token property">border-radius</span><span class="token punctuation">:</span> 5px<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token selector">.test-api</span><span class="token punctuation">{</span>
    <span class="token property">width</span><span class="token punctuation">:</span> 800px<span class="token punctuation">;</span>
    <span class="token property">text-align</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>
    <span class="token property">margin</span><span class="token punctuation">:</span> 100px auto 50px<span class="token punctuation">;</span>
    <span class="token property">border</span><span class="token punctuation">:</span> 1px solid #999<span class="token punctuation">;</span>
    <span class="token property">border-radius</span><span class="token punctuation">:</span> 10px<span class="token punctuation">;</span>
    <span class="token property">padding</span><span class="token punctuation">:</span> 50px 0<span class="token selector">;
    a</span><span class="token punctuation">{</span>
        <span class="token property">background</span><span class="token punctuation">:</span> orangered<span class="token punctuation">;</span>
        <span class="token property">color</span><span class="token punctuation">:</span> #fff<span class="token punctuation">;</span>
        <span class="token property">line-height</span><span class="token punctuation">:</span> 50px<span class="token punctuation">;</span>
        <span class="token property">display</span><span class="token punctuation">:</span> inline-block<span class="token punctuation">;</span>
        <span class="token property">width</span><span class="token punctuation">:</span> 120px<span class="token punctuation">;</span>
        <span class="token property">border-radius</span><span class="token punctuation">:</span> 10px<span class="token punctuation">;</span>
        <span class="token property">text-decoration</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
&lt;/style&gt;
</code></pre></div><h2 id="前后端异步通讯示例"><a href="#前后端异步通讯示例" class="header-anchor">#</a> 前后端异步通讯示例</h2> <h3 id="服务端"><a href="#服务端" class="header-anchor">#</a> 服务端</h3> <p>express模拟一个需要异步处理的接口：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//router中的good.js文件，路由相当于good/socket</span>
<span class="token comment">//改变写法，return一个方法体 通过app.js带回io参数</span>
<span class="token keyword">var</span> <span class="token function-variable function">returnAdminRouter</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">io</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">//测试socket的接口</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/socket&quot;</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span>res<span class="token punctuation">,</span>next</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        meta<span class="token punctuation">:</span> <span class="token punctuation">{</span>
            success<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            message<span class="token punctuation">:</span> <span class="token string">'提交成功'</span><span class="token punctuation">,</span>
            isindex<span class="token punctuation">:</span> <span class="token number">0</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        data<span class="token punctuation">:</span> <span class="token punctuation">{</span>
            data<span class="token punctuation">:</span> <span class="token keyword">null</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        io<span class="token punctuation">.</span>sockets<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'buySuccess'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> msg<span class="token punctuation">:</span> <span class="token string">'购买成功'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">5000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">return</span> router<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> returnAdminRouter<span class="token punctuation">;</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//app.js中</span>
<span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span>io <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'socket.io'</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> goodsRouter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./routes/goods'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>app<span class="token punctuation">.</span>io<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//将原先路由require 增加io参数</span>
</code></pre></div><div class="language-js extra-class"><div class="highlight-lines"><br><br><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-js"><code><span class="token comment">//www.js中</span>
<span class="token keyword">var</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 引入socket.io模块并创建socket服务器</span>
<span class="token comment">//var io = app.io.listen(server);</span>
<span class="token keyword">var</span> io <span class="token operator">=</span> app<span class="token punctuation">.</span>io<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token comment">// io 各种事件</span>
chatcore<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span>io<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Listen on provided port, on all network interfaces.
 */</span>

server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> onError<span class="token punctuation">)</span><span class="token punctuation">;</span>
server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'listening'</span><span class="token punctuation">,</span> onListening<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="客户端"><a href="#客户端" class="header-anchor">#</a> 客户端</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">goBuy</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//模拟后台的异步接口操作</span>
    <span class="token comment">//比如请求一个购套餐接口，但是由于后台是异步操作，刚开始只能知道提交成功，挂起状态中等待其处理完成后再次返回订购成功</span>
    <span class="token comment">//let socket = io('http://127.0.0.1:3000/')</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>$axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/goods/socket'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>success<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">//先立即活动提交成功的提示</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$alert</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
            <span class="token comment">//异步购买成功时，通过socket实时监听到事件，返回购买成功提示</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>$socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'buySuccess'</span><span class="token punctuation">,</span> <span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>msg<span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$alert</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>msg<span class="token punctuation">)</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>$socket<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>文章中内容参考<a href="https://www.jianshu.com/p/ddba1f96cc1e" target="_blank" rel="noopener noreferrer">https://www.jianshu.com/p/ddba1f96cc1e<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><br> <a href="https://www.runoob.com/html/html5-websocket.html" target="_blank" rel="noopener noreferrer">https://www.runoob.com/html/html5-websocket.html<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.00939f34.js" defer></script><script src="/assets/js/2.8fadd415.js" defer></script><script src="/assets/js/9.ef45ba9b.js" defer></script>
  </body>
</html>
